<template>
  <section class="space-y-10">
    <!-- Hero -->
    <div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 text-white px-6 py-12 shadow-xl">
      <div class="absolute inset-0 opacity-30 pointer-events-none" style="background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.18), transparent 40%), radial-gradient(circle at 80% 0%, rgba(255,255,255,0.1), transparent 35%);"></div>
      <div class="relative flex flex-col lg:flex-row items-center gap-10">
        <div class="flex-1 space-y-5">
          <div class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs uppercase tracking-wide text-slate-100 border border-white/15">
            –°–æ–æ–±—â–µ—Å—Ç–≤–æ —Ü–µ–Ω ‚Ä¢ –ë–µ–∑ —Å–ø–∞–º–∞
          </div>
          <h1 class="text-3xl sm:text-4xl font-bold leading-tight">
            PriceCrowd –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å —á–µ—Å—Ç–Ω—ã–µ —Ü–µ–Ω—ã –∏ –¥–µ–ª–∏—Ç—å—Å—è –Ω–∞—Ö–æ–¥–∫–∞–º–∏
          </h1>
          <p class="text-slate-200 text-lg max-w-2xl">
            –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —á–µ–∫–∏, —Å—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ü–µ–Ω—ã –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–Ω–∏–∂–µ–Ω–∏—è–º–∏. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ ‚Äî –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.
          </p>
          <div class="flex flex-wrap gap-3">
            <RouterLink to="/scan" class="inline-flex items-center gap-2 rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 transition">
              üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫
            </RouterLink>
            <RouterLink to="/products" class="inline-flex items-center gap-2 rounded-lg bg-white/10 px-4 py-2 text-sm font-semibold text-white border border-white/20 hover:bg-white/20 transition">
              –°–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä—ã
            </RouterLink>
            <RouterLink to="/rating" class="inline-flex items-center gap-2 rounded-lg bg-white/10 px-4 py-2 text-sm font-semibold text-white border border-white/20 hover:bg-white/20 transition">
              –†–µ–π—Ç–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            </RouterLink>
          </div>
          <div class="flex flex-wrap gap-4 text-sm text-slate-200">
            <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-emerald-400"></span>–û—Ç–∫—Ä—ã—Ç—ã–π —ç–∫—Å–ø–æ—Ä—Ç</div>
            <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-emerald-400"></span>–ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã</div>
            <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-emerald-400"></span>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å QR —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>
          </div>
        </div>
        <div class="w-full max-w-sm rounded-2xl bg-white/10 p-5 border border-white/15 backdrop-blur">
          <div class="text-sm text-slate-200 mb-3">–°–µ–π—á–∞—Å –≤ –±–∞–∑–µ</div>
          <div class="grid grid-cols-2 gap-3">
            <StatCard title="–¢–æ–≤–∞—Ä–æ–≤" :value="stats.products" />
            <StatCard title="–ú–∞–≥–∞–∑–∏–Ω–æ–≤" :value="stats.stores" />
            <StatCard title="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π" :value="activities.length" />
            <StatCard title="–ö–∞—Ç–µ–≥–æ—Ä–∏–π" :value="stats.categories" />
          </div>
          <div class="mt-4 rounded-lg bg-white/10 p-3 text-xs text-slate-200 border border-white/15">
            –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –≤—ã–≥—Ä—É–∑–∏—Ç—å –≤ –æ–¥–∏–Ω –∫–ª–∏–∫.
          </div>
        </div>
      </div>
    </div>

    <!-- How it works -->
    <div class="grid gap-6 lg:grid-cols-3">
      <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="text-lg font-semibold mb-2">1. –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ</div>
        <p class="text-slate-600 text-sm">–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–∞–Ω–µ—Ä QR, –¥–æ–±–∞–≤—å—Ç–µ —á–µ–∫ –∑–∞ —Å–µ–∫—É–Ω–¥—ã. –ú—ã –±–µ—Ä–µ–∂–Ω–æ –æ—Ç–Ω–æ—Å–∏–º—Å—è –∫ –¥–∞–Ω–Ω—ã–º –∏ –Ω–µ –ø—Ä–æ—Å–∏–º –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="text-lg font-semibold mb-2">2. –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ</div>
        <p class="text-slate-600 text-sm">–í–∏–¥–∏—Ç–µ —Ü–µ–Ω—ã –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –∏ —Å–≤–µ–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.</p>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="text-lg font-semibold mb-2">3. –î–µ–ª–∏—Ç–µ—Å—å –≤—ã–≥–æ–¥–æ–π</div>
        <p class="text-slate-600 text-sm">–ü–æ–ª—É—á–∞–π—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ –∏ –ø–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥–∏–º –ø–æ–∫—É–ø–∞—Ç—å –¥–µ—à–µ–≤–ª–µ.</p>
      </div>
    </div>

    <!-- Recent activity -->
    <div class="rounded-3xl border border-slate-200 bg-white shadow-sm">
      <div class="flex items-center justify-between px-6 py-4">
        <div>
          <div class="text-lg font-semibold">–°–≤–µ–∂–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
          <div class="text-sm text-slate-500">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω</div>
        </div>
        <RouterLink to="/stores" class="text-sm text-blue-600 hover:underline">–ö –º–∞–≥–∞–∑–∏–Ω–∞–º</RouterLink>
      </div>
      <div class="divide-y">
        <div v-for="a in activities.slice(0,6)" :key="a.key" class="px-6 py-4 flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-medium text-slate-900">{{ activityTitle(a) }}</div>
            <div class="text-xs text-slate-500">{{ formatDate(a.ts_ms) }}</div>
          </div>
          <div class="shrink-0 flex items-center gap-3 text-xs">
            <RouterLink v-if="a.product_id" :to="`/products/${a.product_id}`" class="text-blue-600 hover:underline">–¢–æ–≤–∞—Ä</RouterLink>
            <RouterLink v-if="a.store_id" :to="`/stores/${a.store_id}`" class="text-blue-600 hover:underline">–ú–∞–≥–∞–∑–∏–Ω</RouterLink>
          </div>
        </div>
        <div v-if="activities.length===0" class="px-6 py-12 text-center text-slate-500">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π, –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —á–µ–∫</div>
      </div>
    </div>
  </section>
</template>

<script setup lang="ts">
import { onMounted, ref, defineComponent } from 'vue';
import { RouterLink } from 'vue-router';

const API = import.meta.env.VITE_API_URL || 'http://localhost:8080';
const activities = ref<any[]>([]);
const stats = ref<{ products: number; stores: number; categories: number }>({ products: 0, stores: 0, categories: 0 });
const StatCard = defineComponent({
  name: 'StatCard',
  props: { title: { type: String, required: true }, value: { type: Number, required: true } },
  template: `
    <div class="rounded-xl bg-white/15 border border-white/15 text-white px-3 py-3 text-center">
      <div class="text-xs uppercase tracking-wide text-slate-200">{{ title }}</div>
      <div class="text-2xl font-semibold">{{ value }}</div>
    </div>
  `,
});

function formatDate(ms: number) {
  try { return new Date(ms).toLocaleString(); } catch { return String(ms); }
}

function activityTitle(a: any) {
  if (a._type === 'event') {
    if (a.kind === 'receipt_uploaded') return `${a.user ? a.user + ': ' : ''}–ó–∞–≥—Ä—É–∑–∏–ª —á–µ–∫`;
    if (a.kind === 'receipt_verified') return `${a.user ? a.user + ': ' : ''}–ß–µ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω`;
    if (a.kind === 'user_registered') return `${a.user ? a.user + ': ' : ''}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è`;
    return a.message || '–°–æ–±—ã—Ç–∏–µ';
  }
  if (a.kind === 'item_added') return `–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä ${a.product_name || ''} (–≤ ${a.store_name || ''})`.trim();
  if (a.kind === 'price_updated' || a.kind === 'price_set') return `–ò–∑–º–µ–Ω–∏–ª–∞—Å—å —Ü–µ–Ω–∞ ${a.product_name || ''} (–≤ ${a.store_name || ''})`.trim();
  if (a.kind === 'item_removed') return `–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω ${a.product_name || ''} (–≤ ${a.store_name || ''})`.trim();
  return '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
}

async function load() {
  try {
    const [aRes, eRes] = await Promise.all([
      fetch(`${API}/activities`),
      fetch(`${API}/events`),
    ]);
    const acts = aRes.ok ? await aRes.json() : [];
    const evs = eRes.ok ? await eRes.json() : [];
    const mappedActs = (acts || []).map((x: any) => ({
      _type: 'activity',
      key: (typeof x._id === 'string' ? x._id : x._id?.$oid) || `${x.ts_ms}`,
      store_id: (typeof x.store_id === 'string' ? x.store_id : x.store_id?.$oid) || null,
      product_id: (typeof x.product_id === 'string' ? x.product_id : x.product_id?.$oid) || null,
      kind: x.kind,
      ts_ms: x.ts_ms,
      product_name: x.product_name,
      store_name: x.store_name,
    }));
    const mappedEvents = (evs || []).map((e: any, i: number) => ({
      _type: 'event',
      key: `ev_${i}_${e.ts_ms}`,
      kind: e.kind,
      ts_ms: e.ts_ms,
      message: e.message,
      user: e.user,
    }));
    activities.value = [...mappedEvents, ...mappedActs].sort((a: any, b: any) => (b.ts_ms || 0) - (a.ts_ms || 0));
  } catch {}

  try {
    const [pRes, sRes, cRes] = await Promise.all([
      fetch(`${API}/products`),
      fetch(`${API}/stores`),
      fetch(`${API}/categories`),
    ]);
    const products = pRes.ok ? await pRes.json() : [];
    const stores = sRes.ok ? await sRes.json() : [];
    const categories = cRes.ok ? await cRes.json() : [];
    stats.value = {
      products: Array.isArray(products) ? products.length : 0,
      stores: Array.isArray(stores) ? stores.length : 0,
      categories: Array.isArray(categories) ? categories.length : 0,
    };
  } catch {}
}

onMounted(load);
</script>
